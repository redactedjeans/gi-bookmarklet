<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Teyvat Interactive Map Bookmarklets</title>
    <link rel="icon" href="favicon.ico">
    <style>
      * { box-sizing: border-box; }
      :root { font-size: 62.5%; }
      html, body, h1 { margin: 0; }
      body { font-family: sans-serif; font-size: 1.5rem; padding: 1rem; }
      ul.options { list-style: none; padding-left: 1.5rem; }
      ul.options > li { margin-bottom: 1rem; }
      ul.options > li .desc::before {
        font-style: normal;
        font-weight: bold;
        font-size: 75%;
        line-height: normal;
        color: var(--color);
        border-radius: 1rem;
        border: 2px solid var(--color);
        padding: 0 .3rem;
      }
      ul.options > li.wip .desc::before { content: 'WIP'; --color: #922; }
      .options .desc { font-style: italic; color: #444; line-height: 3rem; }
      .issues { font-size: 1.2rem; text-transform: uppercase; color: #444; }
    </style>
  </head>
  <body>
    <h1>Teyvat Interactive Map Bookmarklets</h1>
    <ul class="options">
      <li class="wip">
        <label>
          <input type="checkbox" aria-describedby="cf-desc" data-path="src/css-tweaks">
          CSS Tweaks
        </label>
        <div id="cf-desc" class="desc">
          Applies various CSS fixes/tweaks to the map.
        </div>
      </li>
      <li class="wip">
        <label>
          <input type="checkbox" aria-describedby="hc-desc" data-path="src/hide-completed">
          Hide Completed
        </label>
        <div id="hc-desc" class="desc">
          Removes completed options from the sidebar.
        </div>
        <div class="issues">Known issues: does not hide pins from the map</div>
      </li>
    </ul>
    <div>
      Bookmark the following link:
      <a id="bookmarklet" href="javascript:(function(){})();">Teyvat Interactive Map Bookmarklet</a>
    </div>

    <script>
      // apply listener to concat bookmarklet functions
      // FIXME: assumes the code has already been fetched (otherwise this won't work)
      document.querySelector('.options')
        .addEventListener('change', e => {
          const code = [...document.querySelectorAll('.options input:checked')]
            .map(chk => chk.dataset.code)
            .join('');
          document.getElementById('bookmarklet').href = `javascript:(function(){${code}})();`;
        });

      // get the code for each bookmarklet/function
      document.querySelectorAll('.options [data-path]')
        .forEach(fn => {
          // uncheck on load to avoid issues where link href doesn't match checked functions
          fn.checked = false;
          fetch(`./${fn.dataset.path}/main.js?v=${Date.now()}`)
            // FIXME: the promise resolves even if the server returns an error (e.g. 404 or 500)
            .then(resp => resp.text())
            .then(tpl => {
              fn.dataset.code = tpl
                // replace "static" values
                .replace('{src}', fn.dataset.path)
                .replace('{url}', window.location.toString().replace(/\/#?$/, ''))
                // TODO: replace dynamic values (?)
                // remove newlines
                .replace(/\r?\n\s*/g, '')
                // remove comments (since there are no newlines this should work? eh)
                .replace(/\/\*.*?\*\//g, '');
                // TODO: can we detect variable declarations (const, let, etc.) and namespace them?
              console.log(`fetched ${fn.labels[0].innerText.trim()} bookmarklet`);
            })
            .catch(err => console.error(err));
        });
    </script>
  </body>
</html>